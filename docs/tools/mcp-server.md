# เซิร์ฟเวอร์ MCP กับ Gemini CLI

เอกสารนี้ให้คู่มือการกำหนดค่าและใช้งานเซิร์ฟเวอร์ Model Context Protocol (MCP) กับ Gemini CLI

## เซิร์ฟเวอร์ MCP คืออะไร?

เซิร์ฟเวอร์ MCP เป็นแอปพลิเคชันที่เปิดเผยเครื่องมือและทรัพยากรให้กับ Gemini CLI ผ่าน Model Context Protocol ทำให้สามารถโต้ตอบกับระบบภายนอกและแหล่งข้อมูลได้ เซิร์ฟเวอร์ MCP ทำหน้าที่เป็นสะพานเชื่อมระหว่างโมเดล Gemini และสภาพแวดล้อมในเครื่องหรือบริการอื่นๆ เช่น APIs

เซิร์ฟเวอร์ MCP ช่วยให้ Gemini CLI สามารถ:

- **ค้นพบเครื่องมือ:** แสดงรายการเครื่องมือที่มีอยู่ คำอธิบาย และพารามิเตอร์ผ่านการกำหนด schema มาตรฐาน
- **ดำเนินการเครื่องมือ:** เรียกใช้เครื่องมือเฉพาะด้วยอาร์กิวเมนต์ที่กำหนดและรับการตอบสนองที่มีโครงสร้าง
- **เข้าถึงทรัพยากร:** อ่านข้อมูลจากทรัพยากรเฉพาะ (แม้ว่า Gemini CLI จะเน้นการดำเนินการเครื่องมือเป็นหลัก)

ด้วยเซิร์ฟเวอร์ MCP คุณสามารถขยายความสามารถของ Gemini CLI เพื่อทำการกระทำเกินกว่าฟีเจอร์ที่มีอยู่ในตัว เช่น การโต้ตอบกับฐานข้อมูล APIs สคริปต์แบบกำหนดเอง หรือเวิร์กโฟลว์เฉพาะ

## สถาปัตยกรรมการรวมระบบหลัก

Gemini CLI รวมระบบกับเซิร์ฟเวอร์ MCP ผ่านระบบการค้นพบและการดำเนินการที่ซับซ้อนที่สร้างขึ้นในแพ็คเกจหลัก (`packages/core/src/tools/`):

### ชั้นการค้นพบ (`mcp-client.ts`)

กระบวนการค้นพบถูกจัดการโดย `discoverMcpTools()` ซึ่ง:

1. **วนซ้ำผ่านเซิร์ฟเวอร์ที่กำหนดค่า** จากการกำหนดค่า `mcpServers` ใน `settings.json` ของคุณ
2. **สร้างการเชื่อมต่อ** โดยใช้กลไกการขนส่งที่เหมาะสม (Stdio, SSE หรือ Streamable HTTP)
3. **ดึงการกำหนดเครื่องมือ** จากแต่ละเซิร์ฟเวอร์โดยใช้โปรโตคอล MCP
4. **ทำความสะอาดและตรวจสอบ** schema ของเครื่องมือเพื่อความเข้ากันได้กับ Gemini API
5. **ลงทะเบียนเครื่องมือ** ในรีจิสทรีเครื่องมือทั่วไปพร้อมการแก้ไขข้อขัดแย้ง

### ชั้นการดำเนินการ (`mcp-tool.ts`)

เครื่องมือ MCP แต่ละตัวที่ค้นพบจะถูกห่อหุ้มใน instance `DiscoveredMCPTool` ที่:

- **จัดการตรรกะการยืนยัน** ตามการตั้งค่าความไว้วางใจของเซิร์ฟเวอร์และการตั้งค่าผู้ใช้
- **จัดการการดำเนินการเครื่องมือ** โดยเรียกใช้เซิร์ฟเวอร์ MCP ด้วยพารามิเตอร์ที่เหมาะสม
- **ประมวลผลการตอบสนอง** สำหรับทั้งบริบท LLM และการแสดงผลผู้ใช้
- **รักษาสถานะการเชื่อมต่อ** และจัดการ timeouts

### กลไกการขนส่ง

Gemini CLI รองรับประเภทการขนส่ง MCP สามแบบ:

- **Stdio Transport:** สร้าง subprocess และสื่อสารผ่าน stdin/stdout
- **SSE Transport:** เชื่อมต่อกับ endpoints Server-Sent Events
- **Streamable HTTP Transport:** ใช้ HTTP streaming สำหรับการสื่อสาร

## วิธีตั้งค่าเซิร์ฟเวอร์ MCP ของคุณ

Gemini CLI ใช้การกำหนดค่า `mcpServers` ในไฟล์ `settings.json` เพื่อค้นหาและเชื่อมต่อกับเซิร์ฟเวอร์ MCP การกำหนดค่านี้รองรับหลายเซิร์ฟเวอร์ด้วยกลไกการขนส่งที่แตกต่างกัน

### กำหนดค่าเซิร์ฟเวอร์ MCP ใน settings.json

คุณสามารถกำหนดค่าเซิร์ฟเวอร์ MCP ในระดับทั่วไปในไฟล์ `~/.gemini/settings.json` หรือในไดเร็กทอรีรูทของโครงการ สร้างหรือเปิดไฟล์ `.gemini/settings.json` ภายในไฟล์ เพิ่มบล็อกการกำหนดค่า `mcpServers`

### โครงสร้างการกำหนดค่า

เพิ่มออบเจ็กต์ `mcpServers` ลงในไฟล์ `settings.json` ของคุณ:

```json
{ 
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### คุณสมบัติการกำหนดค่า

การกำหนดค่าเซิร์ฟเวอร์แต่ละตัวรองรับคุณสมบัติต่อไปนี้:

#### จำเป็น (หนึ่งในต่อไปนี้)

- **`command`** (string): เส้นทางไปยัง executable สำหรับการขนส่ง Stdio
- **`url`** (string): URL endpoint SSE (เช่น `"http://localhost:8080/sse"`)
- **`httpUrl`** (string): URL endpoint HTTP streaming

#### ไม่บังคับ

- **`args`** (string[]): อาร์กิวเมนต์บรรทัดคำสั่งสำหรับการขนส่ง Stdio
- **`env`** (object): ตัวแปรสภาพแวดล้อมสำหรับกระบวนการเซิร์ฟเวอร์ ค่าสามารถอ้างอิงตัวแปรสภาพแวดล้อมโดยใช้ไวยากรณ์ `$VAR_NAME` หรือ `${VAR_NAME}`
- **`cwd`** (string): ไดเร็กทอรีทำงานสำหรับการขนส่ง Stdio
- **`timeout`** (number): timeout คำขอในมิลลิวินาที (ดีฟอลต์: 600,000ms = 10 นาที)
- **`trust`** (boolean): เมื่อเป็น `true` จะข้ามการยืนยันการเรียกใช้เครื่องมือทั้งหมดสำหรับเซิร์ฟเวอร์นี้ (ดีฟอลต์: `false`)

## ตัวอย่างการกำหนดค่า

### เซิร์ฟเวอร์ MCP Python (Stdio)

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

### เซิร์ฟเวอร์ MCP Node.js (Stdio)

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

### เซิร์ฟเวอร์ MCP ที่ใช้ Docker

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

### เซิร์ฟเวอร์ MCP ที่ใช้ HTTP

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

## การโต้ตอบกับเซิร์ฟเวอร์ MCP ของคุณ

### การใช้คำสั่ง `/mcp`

คำสั่ง `/mcp` ให้ข้อมูลที่ครอบคลุมเกี่ยวกับการตั้งค่าเซิร์ฟเวอร์ MCP ของคุณ:

```bash
/mcp
```

สิ่งนี้แสดง:

- **รายการเซิร์ฟเวอร์:** เซิร์ฟเวอร์ MCP ที่กำหนดค่าทั้งหมด
- **สถานะการเชื่อมต่อ:** `CONNECTED`, `CONNECTING` หรือ `DISCONNECTED`
- **รายละเอียดเซิร์ฟเวอร์:** สรุปการกำหนดค่า (ไม่รวมข้อมูลที่ละเอียดอ่อน)
- **เครื่องมือที่มีอยู่:** รายการเครื่องมือจากแต่ละเซิร์ฟเวอร์พร้อมคำอธิบาย
- **สถานะการค้นพบ:** สถานะกระบวนการค้นพบโดยรวม

### การใช้เครื่องมือ

เมื่อค้นพบแล้ว เครื่องมือ MCP จะพร้อมใช้งานกับโมเดล Gemini เช่นเดียวกับเครื่องมือที่มีอยู่ในตัว โมเดลจะ:

1. **เลือกเครื่องมือที่เหมาะสม** ตามคำขอของคุณ
2. **แสดงกล่องโต้ตอบการยืนยัน** (เว้นแต่เซิร์ฟเวอร์จะได้รับความไว้วางใจ)
3. **ดำเนินการเครื่องมือ** ด้วยพารามิเตอร์ที่เหมาะสม
4. **แสดงผลลัพธ์** ในรูปแบบที่เป็นมิตรกับผู้ใช้

## การตรวจสอบสถานะและการแก้ไขปัญหา

### ปัญหาทั่วไปและการแก้ไข

#### เซิร์ฟเวอร์เชื่อมต่อไม่ได้

**อาการ:** เซิร์ฟเวอร์แสดงสถานะ `DISCONNECTED`

**การแก้ไขปัญหา:**

1. **ตรวจสอบการกำหนดค่า:** ตรวจสอบว่า `command`, `args` และ `cwd` ถูกต้อง
2. **ทดสอบด้วยตนเอง:** รันคำสั่งเซิร์ฟเวอร์โดยตรงเพื่อให้แน่ใจว่าทำงาน
3. **ตรวจสอบ dependencies:** ตรวจสอบว่าแพ็คเกจที่จำเป็นทั้งหมดติดตั้งแล้ว
4. **ตรวจสอบ logs:** มองหาข้อความข้อผิดพลาดในผลลัพธ์ CLI
5. **ตรวจสอบสิทธิ์:** ตรวจสอบว่า CLI สามารถรันคำสั่งเซิร์ฟเวอร์ได้

#### ไม่พบเครื่องมือ

**อาการ:** เซิร์ฟเวอร์เชื่อมต่อแต่ไม่มีเครื่องมือพร้อมใช้งาน

**การแก้ไขปัญหา:**

1. **ตรวจสอบการลงทะเบียนเครื่องมือ:** ตรวจสอบว่าเซิร์ฟเวอร์ของคุณลงทะเบียนเครื่องมือจริง
2. **ตรวจสอบโปรโตคอล MCP:** ยืนยันว่าเซิร์ฟเวอร์ของคุณใช้การแสดงรายการเครื่องมือ MCP อย่างถูกต้อง
3. **ตรวจสอบ logs เซิร์ฟเวอร์:** ตรวจสอบผลลัพธ์ stderr สำหรับข้อผิดพลาดฝั่งเซิร์ฟเวอร์

## หมายเหตุสำคัญ

### ข้อควรพิจารณาด้านความปลอดภัย

- **การตั้งค่าความไว้วางใจ:** ตัวเลือก `trust` ข้ามกล่องโต้ตอบการยืนยันทั้งหมด ใช้อย่างระมัดระวังและเฉพาะกับเซิร์ฟเวอร์ที่คุณควบคุมอย่างสมบูรณ์เท่านั้น
- **โทเค็นการเข้าถึง:** ระวังด้านความปลอดภัยเมื่อกำหนดค่าตัวแปรสภาพแวดล้อมที่มี API keys หรือโทเค็น
- **ความเข้ากันได้กับ Sandbox:** เมื่อใช้ sandboxing ตรวจสอบว่าเซิร์ฟเวอร์ MCP พร้อมใช้งานภายในสภาพแวดล้อม sandbox

### การจัดการประสิทธิภาพและทรัพยากร

- **การเชื่อมต่อแบบถาวร:** CLI รักษาการเชื่อมต่อแบบถาวรกับเซิร์ฟเวอร์ที่ลงทะเบียนเครื่องมือสำเร็จ
- **การทำความสะอาดอัตโนมัติ:** การเชื่อมต่อกับเซิร์ฟเวอร์ที่ไม่ให้เครื่องมือจะถูกปิดโดยอัตโนมัติ
- **การจัดการ Timeout:** กำหนดค่า timeouts ที่เหมาะสมตามลักษณะการตอบสนองของเซิร์ฟเวอร์ของคุณ
